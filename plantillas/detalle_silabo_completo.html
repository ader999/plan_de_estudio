{% extends 'base.html' %}

{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/shared_styles.css' %}">
<link rel="stylesheet" href="{% static 'css/blog_style.css' %}">

<div class="container main-page-container blog-post-style">
    <!-- Botón de regreso -->
    <div class="back-button mb-4">
        <a href="{% url 'plan_de_estudio' %}" class="btn btn-outline-secondary btn-sm">
            « Volver al Plan de Estudio
        </a>
    </div>

    <!-- Encabezado de la página -->
    <header class="page-main-header mb-5 text-center text-white">
        {% if silabos_agrupados %}
            {% for codigo, silabos in silabos_agrupados.items %}
                {% if forloop.first %}
                {% with first_silabo=silabos|first %}
                <h1 class="display-5 fw-bold">{{ first_silabo.asignatura.nombre }}</h1>
                <p class="lead text-muted">{{ codigo }} - {{ first_silabo.carrera.nombre }}</p>
                <p class="meta-info">
                    {{ silabos|length }} encuentro{{ silabos|length|pluralize }} disponible{{ silabos|length|pluralize }}
                </p>
                {% endwith %}
                {% endif %}
            {% endfor %}
        {% else %}
            <h1 class="display-5 fw-bold">Sílabo y Guía de Estudio</h1>
            <p class="lead text-muted">Contenidos académicos por encuentro</p>
        {% endif %}
    </header>

    <!-- Contenido principal -->
    <div class="silabo-component">
        {% for codigo_grupo, silabos_lista in silabos_agrupados.items %}
        <div class="content-component-wrapper mb-5" data-codigo-grupo="{{ codigo_grupo }}">
            
            {% if silabos_lista %}
                <!-- Paginación de Encuentros (Común para Sílabo y Guía) -->
                <nav aria-label="Encuentro navigation {{ codigo_grupo }}" class="mb-4">
                    <ul class="pagination justify-content-center" id="encuentro-pagination-{{ codigo_grupo }}">
                        <!-- Pagination items will be dynamically generated by JavaScript -->
                    </ul>
                </nav>

                <!-- Contenedor de Sílabos por Encuentro -->
                <div id="silabo-view-{{ codigo_grupo }}">
                    {% for silabo_item in silabos_lista|dictsort:"encuentros" %}
                    <article id="silabo-{{ codigo_grupo }}-{{ silabo_item.encuentros }}" class="encuentro-content-panel silabo-panel post-article {% if forloop.first %}active{% else %}d-none{% endif %}" data-silabo-id="{{ silabo_item.id }}" data-encuentro-index="{{ forloop.counter0 }}">
                        <header class="post-header text-center mb-4">
                            <h2 class="h3">Sílabo: Encuentro {{ silabo_item.encuentros }}</h2>
                            <p class="post-meta text-muted">
                                {{ silabo_item.fecha|date:"d F, Y" }} | Unidad {{ silabo_item.unidad }}: {{ silabo_item.nombre_de_la_unidad }}
                            </p>
                        </header>
                        
                        <section class="post-content">
                            <!-- Contenido Temático -->
                            <div class="content-block mb-4">
                                <h3 class="section-heading h5">Contenido Temático</h3>
                                <div class="text-content">
                                    {{ silabo_item.contenido_tematico|linebreaks }}
                                </div>
                            </div>
                            <!-- Objetivos de la Unidad -->
                            <div class="content-block mb-4">
                                <h3 class="section-heading h5">Objetivos de la Unidad</h3>
                                <ul class="styled-list">
                                    <li><strong>Conceptual:</strong> {{ silabo_item.objetivo_conceptual }}</li>
                                    <li><strong>Procedimental:</strong> {{ silabo_item.objetivo_procedimental }}</li>
                                    <li><strong>Actitudinal:</strong> {{ silabo_item.objetivo_actitudinal }}</li>
                                </ul>
                            </div>
                            <!-- Momentos Didácticos -->
                            <div class="content-block mb-4">
                                <h3 class="section-heading h5">Momentos Didácticos</h3>
                                <div class="momentos-grid">
                                    <div class="momento-card">
                                        <h4 class="momento-title h6">Primer Momento (Entrada)</h4>
                                        <p><strong>Tipo:</strong> {{ silabo_item.tipo_primer_momento }}</p>
                                        <p><strong>Detalle:</strong> {{ silabo_item.detalle_primer_momento|linebreaksbr }}</p>
                                        <p><strong>Tiempo:</strong> {{ silabo_item.tiempo_primer_momento }} minutos</p>
                                        <p><strong>Recursos:</strong> {{ silabo_item.recursos_primer_momento }}</p>
                                    </div>
                                    <div class="momento-card">
                                        <h4 class="momento-title h6">Segundo Momento (Elaboración)</h4>
                                        <p><strong>Tipo clase teórica:</strong> {{ silabo_item.tipo_segundo_momento_claseteoria }}</p>
                                        <p><strong>Clase teórica:</strong> {{ silabo_item.clase_teorica|linebreaksbr }}</p>
                                        <p><strong>Tiempo clase teórica:</strong> {{ silabo_item.tiempo_segundo_momento_teorica }} minutos</p>
                                        <hr class="my-2">
                                        <p><strong>Tipo clase práctica:</strong> {{ silabo_item.tipo_segundo_momento_practica }}</p>
                                        <p><strong>Clase práctica:</strong> {{ silabo_item.clase_practica|linebreaksbr }}</p>
                                        <p><strong>Tiempo clase práctica:</strong> {{ silabo_item.tiempo_segundo_momento_practica }} minutos</p>
                                        <hr class="my-2">
                                        <p><strong>Recursos:</strong> {{ silabo_item.recursos_segundo_momento }}</p>
                                    </div>
                                    <div class="momento-card">
                                        <h4 class="momento-title h6">Tercer Momento (Salida)</h4>
                                        <p><strong>Tipo:</strong> {{ silabo_item.tipo_tercer_momento }}</p>
                                        <p><strong>Detalle:</strong> {{ silabo_item.detalle_tercer_momento|linebreaksbr }}</p>
                                        <p><strong>Tiempo:</strong> {{ silabo_item.tiempo_tercer_momento }} minutos</p>
                                        <p><strong>Recursos:</strong> {{ silabo_item.recursos_tercer_momento }}</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Ejes transversales -->
                            <div class="content-block mb-4">
                                <h3 class="section-heading h5">Ejes Transversales</h3>
                                <p><strong>Ejes:</strong> {{ silabo_item.eje_transversal }}</p>
                                <p><strong>Detalle:</strong> {{ silabo_item.detalle_eje_transversal|linebreaksbr }}</p>
                            </div>
                            <!-- Evaluación dinámica -->
                            <div class="content-block mb-4">
                                <h3 class="section-heading h5">Evaluación Dinámica</h3>
                                <div class="evaluation-details">
                                    <p><strong>Actividad de aprendizaje:</strong> {{ silabo_item.actividad_aprendizaje }}</p>
                                    <p><strong>Técnica:</strong> {{ silabo_item.tecnica_evaluacion }}</p>
                                    <p><strong>Tipo:</strong> {{ silabo_item.tipo_evaluacion }}</p>
                                    <p><strong>Periodo:</strong> {{ silabo_item.periodo_tiempo_programado }}</p>
                                    <p><strong>Tiempo:</strong> {{ silabo_item.tiempo_minutos }} minutos</p>
                                    <p><strong>Agente:</strong> {{ silabo_item.agente_evaluador }}</p>
                                    <p><strong>Instrumento:</strong> {{ silabo_item.instrumento_evaluacion }}</p>
                                    <p><strong>Criterios:</strong> {{ silabo_item.criterios_evaluacion|linebreaksbr }}</p>
                                    <p><strong>Puntaje:</strong> {{ silabo_item.puntaje }}</p>
                                </div>
                            </div>

                            <footer class="update-button-container">
                            <a href="{% url 'actualizar_silabo' silabo_id=silabo_item.id %}" class="btn btn-update-silabo">
                                <i class="fas fa-pencil-alt me-2"></i> Actualizar este Sílabo
                            </a>
                        </footer>


                        </section>
                    </article>


                    {% endfor %}




                </div>

                <!-- Contenedor de Guías de Estudio por Encuentro -->
                <div id="guias-view-{{ codigo_grupo }}" class="mt-4"> {# Un poco de margen superior #}
                    {% for silabo_item in silabos_lista|dictsort:"encuentros" %}
                    <article id="guia-{{ codigo_grupo }}-{{ silabo_item.encuentros }}" class="encuentro-content-panel guia-panel post-article {% if forloop.first %}active{% else %}d-none{% endif %}" data-silabo-id="{{ silabo_item.id }}" data-encuentro-index="{{ forloop.counter0 }}" data-loaded="false">
                        <header class="post-header text-center mb-4">
                            <h2 class="h3">Guía de Estudio: Encuentro {{ silabo_item.encuentros }}</h2>
                             <p class="post-meta text-muted">
                                Unidad {{ silabo_item.unidad }}: {{ silabo_item.nombre_de_la_unidad }}
                            </p>
                        </header>
                        <section class="post-content guia-dynamic-content">
                            <div class="loading-message text-center py-5">
                                <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>
                                <p class="mt-3 text-muted">Cargando guía de estudio para el encuentro {{ silabo_item.encuentros }}...</p>
                            </div>
                        </section>
                        <footer class="update-button-container">
                            <a href="{% url 'actualizar_guia' guia_id=silabo_item.guias.first.id %}" class="btn btn-update-silabo">
                                <i class="fas fa-pencil-alt me-2"></i> Actualizar esta Guía
                            </a>
                        </footer>
                    </article>
                    {% endfor %}
                </div>
            
                <!-- Paginación de Encuentros (abajo, opcional) -->
                <nav aria-label="Encuentro navigation {{ codigo_grupo }} bottom" class="mt-5">
                    <ul class="pagination justify-content-center" id="encuentro-pagination-{{ codigo_grupo }}-bottom">
                        <!-- JS will duplicate pagination here or you can choose to have it only once -->
                    </ul>
                </nav>
            {% else %}
                <div class="alert alert-info text-center">No hay encuentros de sílabo para mostrar para el código {{ codigo_grupo }}.</div>
            {% endif %}
        </div>
        {% empty %}
        <div class="info-message text-center">
            <h2 class="h2">No hay sílabos disponibles</h2>
            <p class="text-muted">
                {% if request.GET.codigo %}
                    No se encontraron sílabos para la asignación con código <strong>{{ request.GET.codigo }}</strong>.
                {% else %}
                    No tienes sílabos asignados en este momento.
                {% endif %}
            </p>
            <div class="mt-4">
                <a href="{% url 'plan_de_estudio' %}" class="btn btn-primary">
                    Volver al Plan de Estudio
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM fully loaded for INTEGRATED detalle_silabo_completo.html.");

    function cargarGuia(silaboId, targetContentDiv, guiaPanelElement) {
        // Muestra el mensaje de carga solo si el contenido dinámico está vacío o tiene el mensaje por defecto
        const isLoadingMessagePresent = targetContentDiv.querySelector('.loading-message');
        if (!targetContentDiv.innerHTML.trim() || isLoadingMessagePresent) {
            targetContentDiv.innerHTML = `
                <div class="loading-message text-center py-5">
                    <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>
                    <p class="mt-3 text-muted">Cargando guía de estudio...</p>
                </div>
            `;
        }
        
        fetch(`/cargar_guia/${silaboId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Asumimos que data.html ya viene simplificado y sin iconos desde el backend
                    targetContentDiv.innerHTML = data.html; 
                    if (guiaPanelElement) guiaPanelElement.setAttribute('data-loaded', 'true');
                } else {
                    targetContentDiv.innerHTML = `<div class="alert alert-warning" role="alert">${data.message || 'No se pudo cargar la guía.'}</div>`;
                }
            })
            .catch(error => {
                console.error('Error al cargar la guía:', error);
                targetContentDiv.innerHTML = `<div class="alert alert-danger" role="alert">Error al cargar la guía. Por favor, intente de nuevo más tarde.</div>`;
            });
    }

    function showEncuentroPage(codigoGrupo, pageIndex) {
        const silaboViewContainer = document.getElementById(`silabo-view-${codigoGrupo}`);
        const guiasViewContainer = document.getElementById(`guias-view-${codigoGrupo}`);

        if (!silaboViewContainer || !guiasViewContainer) {
            console.error(`Contenedores para ${codigoGrupo} no encontrados.`);
            return;
        }

        const silaboEncuentroPanels = silaboViewContainer.querySelectorAll('.silabo-panel');
        const guiaEncuentroPanels = guiasViewContainer.querySelectorAll('.guia-panel');
        
        const paginationUls = [
            document.getElementById(`encuentro-pagination-${codigoGrupo}`),
            document.getElementById(`encuentro-pagination-${codigoGrupo}-bottom`)
        ].filter(ul => ul);

        // Actualizar UI de paginación
        paginationUls.forEach(paginationUl => {
            const paginationItems = paginationUl.querySelectorAll('.page-item');
            paginationItems.forEach(item => item.classList.remove('active'));
            // pageIndex es 0-based. paginationItems incluye Prev, Page1, Page2,..., Next
            // Así que el número de página 1 (índice 0) corresponde a paginationItems[1]
            if (paginationItems[pageIndex + 1]) { 
                paginationItems[pageIndex + 1].classList.add('active');
            }
            // Habilitar/deshabilitar Prev/Next
            const prevButtonLi = paginationUl.querySelector('.page-item:first-child');
            const nextButtonLi = paginationUl.querySelector('.page-item:last-child');
            if (prevButtonLi) prevButtonLi.classList.toggle('disabled', pageIndex === 0);
            if (nextButtonLi) nextButtonLi.classList.toggle('disabled', pageIndex === silaboEncuentroPanels.length - 1);

        });
        
        // Mostrar/ocultar paneles de Sílabo
        silaboEncuentroPanels.forEach((panel, index) => {
            panel.classList.toggle('active', index === pageIndex);
            panel.classList.toggle('d-none', index !== pageIndex);
        });

        // Mostrar/ocultar paneles de Guía y cargar si es necesario
        guiaEncuentroPanels.forEach((panel, index) => {
            panel.classList.toggle('active', index === pageIndex);
            panel.classList.toggle('d-none', index !== pageIndex);
            
            if (index === pageIndex) { // Si es el panel que se va a mostrar
                const silaboId = panel.getAttribute('data-silabo-id');
                const isLoaded = panel.getAttribute('data-loaded') === 'true';
                
                if (silaboId && !isLoaded) {
                    const dynamicContentDiv = panel.querySelector('.guia-dynamic-content');
                    if (dynamicContentDiv) {
                        cargarGuia(silaboId, dynamicContentDiv, panel);
                    } else {
                        console.error("Elemento .guia-dynamic-content no encontrado en el panel de guía.");
                    }
                }
            }
        });
    }

    function setupEncuentroPagination(codigoGrupo) {
        const silaboViewPanel = document.getElementById(`silabo-view-${codigoGrupo}`);
        if (!silaboViewPanel) return;

        const encuentroPanels = silaboViewPanel.querySelectorAll('.silabo-panel');
        const numEncuentros = encuentroPanels.length;
        
        const paginationTargets = [
            document.getElementById(`encuentro-pagination-${codigoGrupo}`),
            document.getElementById(`encuentro-pagination-${codigoGrupo}-bottom`)
        ].filter(ul => ul);

        if (numEncuentros <= 1) {
            paginationTargets.forEach(ul => ul.closest('nav')?.classList.add('d-none'));
            return;
        }
        
        paginationTargets.forEach(paginationUl => {
            paginationUl.innerHTML = ''; // Limpiar items existentes
            paginationUl.closest('nav')?.classList.remove('d-none');

            const createPageItem = (text, pageIdx, isPrevNext = false, isDisabled = false, isHtml = false) => {
                const li = document.createElement('li');
                li.classList.add('page-item');
                if (isDisabled) li.classList.add('disabled');
                
                const a = document.createElement('a');
                a.classList.add('page-link');
                a.href = '#';
                if (isHtml) a.innerHTML = text; else a.textContent = text;

                if (!isDisabled) {
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (li.classList.contains('disabled')) return;

                        const currentActiveSilaboPanel = silaboViewPanel.querySelector('.silabo-panel.active');
                        let currentIndex = 0;
                        if (currentActiveSilaboPanel) {
                            currentIndex = parseInt(currentActiveSilaboPanel.getAttribute('data-encuentro-index'));
                        }
                        let newIndex;
                        if (isPrevNext) {
                            if (text.includes('«')) newIndex = currentIndex - 1;
                            else newIndex = currentIndex + 1;
                        } else {
                            newIndex = pageIdx;
                        }
                        if (newIndex >= 0 && newIndex < numEncuentros) {
                            showEncuentroPage(codigoGrupo, newIndex);
                        }
                    });
                }
                li.appendChild(a);
                return li;
            };
            
            const currentActiveSilaboPanel = silaboViewPanel.querySelector('.silabo-panel.active');
            const currentPageIndex = currentActiveSilaboPanel ? parseInt(currentActiveSilaboPanel.getAttribute('data-encuentro-index')) : 0;

            paginationUl.appendChild(createPageItem('<span aria-hidden="true">«</span>', null, true, currentPageIndex === 0, true));
            for (let i = 0; i < numEncuentros; i++) {
                const pageLi = createPageItem(i + 1, i);
                 if (i === currentPageIndex) {
                    pageLi.classList.add('active');
                }
                paginationUl.appendChild(pageLi);
            }
            paginationUl.appendChild(createPageItem('<span aria-hidden="true">»</span>', null, true, currentPageIndex === numEncuentros - 1, true));
        });
    }
    
    // Inicialización para cada grupo de sílabos/guías
    document.querySelectorAll('.content-component-wrapper').forEach(wrapper => {
        const codigoGrupo = wrapper.getAttribute('data-codigo-grupo');
        if (codigoGrupo) {
            setupEncuentroPagination(codigoGrupo);

            const urlParams = new URLSearchParams(window.location.search);
            const encuentroParam = urlParams.get('encuentro');
            const hash = window.location.hash;

            let startPageIndex = 0; // Por defecto es el primer encuentro (índice 0)

            if (encuentroParam) {
                // Buscar el panel que corresponde a ese número de encuentro
                const targetPanel = wrapper.querySelector(`#silabo-view-${codigoGrupo} .silabo-panel[id$="-${encuentroParam}"]`);
                if (targetPanel) {
                    startPageIndex = parseInt(targetPanel.getAttribute('data-encuentro-index'));
                }
            }

            // Mostrar la página correcta al cargar
            showEncuentroPage(codigoGrupo, startPageIndex);

            // Si el hash indica que se debe mostrar la guía, nos aseguramos de que esté visible
            if (hash.startsWith('#guia-')) {
                // No se necesita una acción explícita aquí si showEncuentroPage ya muestra
                // tanto el sílabo como la guía para el índice dado. La carga de la guía
                // ya está manejada dentro de showEncuentroPage.
                console.log(`Ancla a guía detectada: ${hash}. La guía para el encuentro ${startPageIndex + 1} debería estar visible.`);
            }
        }
    });

     console.log('Integrated Detalle Sílabo/Guía (con paginación) cargado y listo.');
});
</script>
{% endblock %}