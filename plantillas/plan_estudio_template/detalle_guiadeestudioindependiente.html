<script>
    // Función para imprimir la guía
    function imprimirGuiaEstudio() {
        window.print();
    }

    // Función para filtrar por número de encuentro
    function filtrarGuiaPorEncuentro(codigo, numero) {
        // Ocultar todos los planes para este código
        document.querySelectorAll(`.guia-${codigo}`).forEach(guia => {
            guia.style.display = 'none';
        });
        
        // Mostrar solo el plan con el número de encuentro seleccionado
        document.querySelector(`.guia-${codigo}-${numero}`).style.display = 'block';
        
        // Actualizar estado visual de los botones
        document.querySelectorAll(`.guia-btn-encuentro-${codigo}`).forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
        });
        
        document.querySelector(`.guia-btn-encuentro-${codigo}-${numero}`).classList.remove('btn-outline-primary');
        document.querySelector(`.guia-btn-encuentro-${codigo}-${numero}`).classList.add('btn-primary');
    }
    
    // Inicializar mostrar solo el primer encuentro al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        // Inicialización para el acordeón que está abierto por defecto
        const guiaPrimerAcordeon = document.querySelector('#accordionGuiaEstudio .accordion-collapse.show');
        if (guiaPrimerAcordeon) {
            const codigo = guiaPrimerAcordeon.id.replace('collapse-', '');
            inicializarFiltradoGuia(codigo);
        }
        
        // Escuchar eventos de apertura de acordeones
        document.querySelectorAll('#accordionGuiaEstudio .accordion-collapse').forEach(function(collapse) {
            collapse.addEventListener('shown.bs.collapse', function() {
                const codigo = this.id.replace('collapse-', '');
                inicializarFiltradoGuia(codigo);
            });
        });
    });
    
    // Función para inicializar el filtrado en un acordeón específico
    function inicializarFiltradoGuia(codigo) {
        // Ocultar todos los encuentros primero
        document.querySelectorAll(`.guia-${codigo}`).forEach(guia => {
            guia.style.display = 'none';
        });
        
        // Encontrar el primer encuentro y mostrarlo
        const primerBoton = document.querySelector(`.guia-btn-encuentro-${codigo}`);
        if (primerBoton) {
            const encuentroNum = primerBoton.getAttribute('data-encuentro');
            filtrarGuiaPorEncuentro(codigo, encuentroNum);
        }
    }
</script>

<!-- Estilos personalizados -->
<style>
    .guia-component {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        padding: 20px;
    }
    
    .guia-card {
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 2rem;
        background-color: white;
    }
    
    .guia-header {
        background: linear-gradient(135deg, var(--color-azul-2), var(--color-azul-oscuro));
        color: white;
        padding: 15px;
        border-radius: 10px 10px 0 0;
        position: relative;
    }
    
    .guia-header::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(90deg, var(--color-azul-1), var(--color-azul-3));
    }
    
    .guia-section {
        border-left: 4px solid var(--color-azul-3);
        margin-bottom: 15px;
        padding-left: 10px;
    }
    
    .guia-section-title {
        background-color: var(--color-gris-1);
        color: white;
        padding: 8px 15px;
        border-radius: 5px;
        margin-bottom: 15px;
        display: inline-block;
    }
    
    .guia-filter-buttons .btn {
        margin-bottom: 5px;
        transition: all 0.3s ease;
    }
    
    .guia-filter-buttons .btn.btn-primary {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .guia-data-table {
        width: 100%;
        margin-bottom: 1rem;
    }
    
    .guia-data-table td:first-child {
        font-weight: bold;
        width: 35%;
        color: var(--color-azul-oscuro);
    }
    
    .guia-accordion-button:not(.collapsed) {
        background-color: var(--color-azul-3);
        color: white;
    }
    
    .guia-accordion-button:focus {
        box-shadow: 0 0 0 0.25rem rgba(46, 134, 193, 0.25);
    }
    
    .guia-accordion-item {
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid rgba(0,0,0,0.125);
        margin-bottom: 1rem;
        background-color: white;
    }
    
    .guia-content-item {
        padding: 10px;
        border-radius: 5px;
        background-color: #f8f9fa;
        margin-bottom: 10px;
    }
    
    .guia-badge {
        padding: 0.5em 0.8em;
    }
    
    .guia-table-responsive {
        overflow-x: auto;
    }
    
    .guia-table {
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .guia-table th {
        background-color: var(--color-azul-2);
        color: white;
        font-weight: 500;
        text-align: center;
    }
    
    .guia-table td, .guia-table th {
        padding: 0.75rem;
        vertical-align: middle;
        border-top: 1px solid #dee2e6;
    }
    
    .guia-content {
        background-color: white;
        color: #212529; /* Ensure text has good contrast on white */
    }
    
    #accordionGuiaEstudio .accordion-body {
        background-color: #f8f9fa;
        padding: 1.5rem;
        color: #212529;
    }
    
    #accordionGuiaEstudio .accordion-collapse {
        background-color: white;
    }
    
    #accordionGuiaEstudio .guia-container {
        background-color: white;
    }
    
    /* Override any background colors from parent elements */
    #accordionGuiaEstudio .guia-section p {
        color: #212529;
    }

    @media print {
        .guia-filter-buttons, .guia-btn-encuentro {
            display: none !important;
        }
        
        .guia-card {
            box-shadow: none;
            break-inside: avoid;
            page-break-inside: avoid;
            margin-bottom: 30px;
        }
        
        .guia-container {
            display: block !important;
        }
        
        .guia-container > div {
            display: block !important;
            width: 100% !important;
        }
    }
</style>

<!-- Acordeón -->
<div class="accordion" id="accordionGuiaEstudio">
    {% for codigo, silabos_grupo in silabos_agrupados.items %}
    <div class="guia-accordion-item mb-4">
        <h2 class="accordion-header" id="heading-{{ codigo }}">
            <button class="accordion-button guia-accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ codigo }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="collapse-{{ codigo }}">
                <div class="d-flex flex-column flex-md-row justify-content-between w-100">
                    <div>
                        <strong> Guía de Estudio Independiente: {{ codigo }}</strong>
                    </div>
                    <div class="d-flex gap-3">
                        {% with primer_silabo=silabos_grupo.0 %}
                        <span class="badge guia-badge" style="background-color: var(--color-azul-2);">{{ primer_silabo.carrera }}</span>
                        <span class="badge guia-badge" style="background-color: var(--color-azul-3);">{{ primer_silabo.fecha|date:"d/m/Y" }}</span>
                        <span class="badge guia-badge" style="background-color: var(--color-azul-oscuro);">
                            <i class="fas fa-calendar-check me-1"></i>
                            Encuentros: {{ silabos_grupo|length }}/12
                        </span>
                        {% endwith %}
                    </div>
                </div>
            </button>
        </h2>
        <div id="collapse-{{ codigo }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" aria-labelledby="heading-{{ codigo }}" data-bs-parent="#accordionGuiaEstudio">
            <div class="accordion-body p-3">
                <!-- Filtro por número de encuentro -->
                <div class="mb-4 guia-filter-buttons">
                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <span class="fw-bold me-2">Filtrar por número de encuentro:</span>
                        {% for silabo in silabos_grupo|dictsort:"encuentros" %}
                        <button 
                            class="btn btn-outline-primary btn-sm guia-btn-encuentro-{{ codigo }} guia-btn-encuentro-{{ codigo }}-{{ silabo.encuentros }}" 
                            onclick="filtrarGuiaPorEncuentro('{{ codigo }}', '{{ silabo.encuentros }}')"
                            data-encuentro="{{ silabo.encuentros }}">
                            Encuentro {{ silabo.encuentros }}
                        </button>
                        {% endfor %}
                        
                        <div class="ms-auto">
                            <button class="btn btn-outline-secondary btn-sm" onclick="imprimirGuiaEstudio()">
                                <i class="fas fa-print"></i> Imprimir
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Contenedor para guías de estudio -->
                <div class="guia-container">
                    {% for silabo in silabos_grupo|dictsort:"encuentros" %}
                    <div class="container mb-5 guia-{{ codigo }} guia-{{ codigo }}-{{ silabo.encuentros }}">
                        <div class="guia-card">
                            <div class="guia-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h4 class="mb-0">
                                        <i class="fas fa-book me-2"></i>
                                        Guía de Estudio Independiente - Encuentro {{ silabo.encuentros }}
                                    </h4>
                                    <span class="badge bg-light text-dark">{{ silabo.fecha|date:"d/m/Y" }}</span>
                                </div>
                            </div>
                            <div class="guia-content p-4">
                                <div class="row g-4">
                                    <!-- Primera columna -->
                                    <div class="col-md-6">
                                        <div class="guia-section">
                                            <h5 class="guia-section-title">
                                                <i class="fas fa-info-circle me-2"></i>
                                                DATOS GENERALES
                                            </h5>
                                            <table class="guia-data-table">
                                                <tr>
                                                    <td>N° de encuentro:</td>
                                                    <td>{{ silabo.encuentros }}</td>
                                                </tr>
                                                <tr>
                                                    <td>Municipio:</td>
                                                    <td>JALAPA</td>
                                                </tr>
                                                <tr>
                                                    <td>Año lectivo:</td>
                                                    <td>{{ silabo.fecha|date:"Y" }}</td>
                                                </tr>
                                                <tr>
                                                    <td>Carrera:</td>
                                                    <td>{{ silabo.carrera }}</td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- Segunda columna -->
                                    <div class="col-md-6">
                                        <div class="guia-section">
                                            <h5 class="guia-section-title">
                                                <i class="fas fa-graduation-cap me-2"></i>
                                                DATOS ACADÉMICOS
                                            </h5>
                                            <table class="guia-data-table">
                                                <tr>
                                                    <td>Asignatura:</td>
                                                    <td>{{ silabo.asignatura.asignatura }}</td>
                                                </tr>
                                                <tr>
                                                    <td>Facilitador:</td>
                                                    <td>{{ silabo.maestro }}</td>
                                                </tr>
                                                <tr>
                                                    <td>Trimestre:</td>
                                                    <td>{{ silabo.asignatura.trimestre }}</td>
                                                </tr>
                                                <tr>
                                                    <td>Año de la carrera:</td>
                                                    <td>{{ silabo.asignatura.año }}</td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- Contenido de la unidad -->
                                    <div class="col-12">
                                        <div class="guia-section">
                                            <h5 class="guia-section-title">
                                                <i class="fas fa-bookmark me-2"></i>
                                                UNIDAD
                                            </h5>
                                            <div class="guia-content-item">
                                                <h6 class="fw-bold">{{ silabo.unidad }}</h6>
                                                <p>{{ silabo.detalle_unidad }}</p>
                                            </div>
                                        </div>
                                        
                                        <div class="guia-section">
                                            <h5 class="guia-section-title">
                                                <i class="fas fa-bullseye me-2"></i>
                                                OBJETIVOS DE LA UNIDAD
                                            </h5>
                                            <div class="guia-content-item">
                                                <h6 class="fw-bold mb-2">Conceptual:</h6>
                                                <p>{{ silabo.objetivo_conceptual }}</p>
                                                
                                                <h6 class="fw-bold mb-2">Procedimental:</h6>
                                                <p>{{ silabo.objetivo_procedimental }}</p>
                                                
                                                <h6 class="fw-bold mb-2">Actitudinal:</h6>
                                                <p>{{ silabo.objetivo_actitudinal }}</p>
                                            </div>
                                        </div>
                                        
                                        <div class="guia-section">
                                            <h5 class="guia-section-title">
                                                <i class="fas fa-tasks me-2"></i>
                                                ACTIVIDADES DE ESTUDIO INDEPENDIENTE
                                            </h5>
                                            <div class="guia-table-responsive">
                                                <table class="guia-table table table-bordered">
                                                    <thead>
                                                        <tr>
                                                            <th width="5%">N°</th>
                                                            <th width="20%">TEMAS</th>
                                                            <th width="25%">ACTIVIDADES A REALIZAR</th>
                                                            <th width="15%">EVALUACIÓN</th>
                                                            <th width="20%">RECURSOS</th>
                                                            <th width="15%">FECHA DE ENTREGA</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td class="text-center">{{ silabo.encuentros }}</td>
                                                            <td>{{ silabo.contenido_tematico }}</td>
                                                            <td>{{ silabo.estudio_independiente.actividades|default:"_____________" }}</td>
                                                            <td>{{ silabo.estudio_independiente.tecnica_evaluacion }}</td>
                                                            <td>{{ silabo.estudio_independiente.recursos_bibliograficos }}</td>
                                                            <td>{{ silabo.estudio_independiente.fecha_entrega }}</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
